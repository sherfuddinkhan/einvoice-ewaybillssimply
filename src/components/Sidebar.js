import React, { useState, useEffect } from "react";
import { Link, useLocation } from "react-router-dom";
import { useAuth } from "../components/AuthContext";

const Sidebar = () => {
  const location = useLocation();
  const { product } = useAuth();

  // Store open/close state per section
  const [openSections, setOpenSections] = useState({});

  const toggle = (title) => {
    setOpenSections((prev) => ({
      ...prev,
      [title]: !prev[title],
    }));
  };

  const isActive = (path) =>
    location.pathname === path ||
    location.pathname.startsWith(path + "/");

  /* --------------------------------
     AUTO OPEN SECTION ON ROUTE
  --------------------------------- */
  useEffect(() => {
    setOpenSections((prev) => {
      const updated = { ...prev };

      menuSections.forEach((section) => {
        if (section.items?.some((i) => isActive(i.path))) {
          updated[section.title] = true;
        }
      });

      return updated;
    });
  }, [location.pathname]);

  /* --------------------------------
     MENU CONFIG
  --------------------------------- */
  const menuSections = [
    {
      title: "Dashboard",
      items: [{ path: "/", label: "Dashboard" }],
    },
    {
      title: "Login / Switch",
      items: [
        { path: "/ewaybill-login", label: "E-Way Bill Login" },
        { path: "/einvoice-login", label: "E-Invoice Login" },
      ],
    },
      {
      title: "Change Password",
      product: "EWAY",
      items: [{ path: "/ewaybill/change-password", label: "Change Password" }],
    },

    /* ================= E-WAY BILL ================= */
    {
      title: "E-Way Bill Core",
      product: "EWAY",
      items: [
        { path: "/ewaybill/ewb-generate-print", label: "Generate & Print" },
        { path: "/ewaybill/fetch-ewb", label: "Fetch by EWB No" },
        { path: "/ewaybill/ewb-details", label: "Get EWB Details" },
      ],
    },
    {
      title: "EWB Actions",
      product: "EWAY",
      items: [
        { path: "/ewaybill/ewb-action", label: "Cancel / Reject EWB" },
        { path: "/ewaybill/update-transporter-id", label: "Update Transporter ID" },
      ],
    },
    {
      title: "Fetch EWB / Consignee",
      product: "EWAY",
      items: [
        { path: "/ewaybill/assigned-ewb", label: "Transporter EWB" },
        { path: "/ewaybill/consignee-ewb", label: "Consignee EWB" },
        { path: "/ewaybill/fetch-by-date", label: "Fetch by Date" },
      ],
    },
     {
      title: "Consolidate Ewaybill",
      product: "EWAY",
      items: [
        { path: "/ewaybill/consolidated-ewb-details", label: "Consolidated EWB" },
        { path: "/ewaybill/consolidate-ewb", label: "Generate Consolidated" },
      ],
    },

    {
      title: "EWB by Document",
      product: "EWAY",
      items: [
        { path: "/ewaybill/by-doc-type", label: "By Doc No & Type" },
        { path: "/ewaybill/generated-by-date", label: "Generated by Date" },
        { path: "/ewaybill/get-by-doc-no", label: "Get by Doc No" },
        { path: "/ewaybill/download-doc", label: "Doc Download" },
        { path: "/ewaybill/get-doc-status", label: "Doc Status" },
      ],
    },
    {
      title: "Multi-Vehicle",
      product: "EWAY",
      items: [
        { path: "/ewaybill/multi-vehicle-initiate", label: "Multi-Vehicle Initiate" },
        { path: "/ewaybill/multi-vehicle-add", label: "Multi-Vehicle Add" },
        { path: "/ewaybill/multi-vehicle-edit", label: "Multi-Vehicle Edit" },
        { path: "/ewaybill/multi-vehicle-group-details", label: "Group Details" },
        { path: "/ewaybill/multi-vehicle-requests", label: "Requests" },
      ],
    },
     {
      title: "EWB Print / Summary",
      product: "EWAY",
      items: [
        { path: "/ewaybill/ewb-print", label: "Print EWB" },
        { path: "/ewaybill/ewb-print-summary", label: "Print Summary" },
      ],
    },
   
    /* ================= E-INVOICE ================= */
    {
      title: "Change Password",
      product: "EINVOICE",
      items: [{ path: "/einvoice/change-password", label: "Change Password" }],
    },

    {
      title: "E-Invoice Core",
      product: "EINVOICE",
      items: [
        { path: "/einvoice/generate-print", label: "Generate Invoice and print" },
        { path: "/einvoice/cancel-irn", label: "Cancel IRN" },
        { path: "/einvoice/get-by-irn", label: "Get by IRN" },
        { path: "/einvoice/get-by-doc", label: "Get by Document" },
      ],
    },
    {
      title: "EWB from IRN",
      product: "EINVOICE",
      items: [
        { path: "/einvoice/generate-ewb-by-irn", label: "Generate EWB" },
        { path: "/einvoice/cancel-ewb-by-irn", label: "Cancel EWB" },
        { path: "/einvoice/get-ewb-by-irn", label: "Get EWB" },
      ],
    },
    {
      title: "Print",
      product: "EINVOICE",
      items: [
        { path: "/einvoice/print-irn", label: "Print Invoice" },
      ],
    },
    {
      title: "Upload",
      product: "EINVOICE",
      items: [
        { path: "/einvoice/upload-invoices", label: "Upload Invoice" },
        { path: "/einvoice/uploaded-file-status", label: "Upload Status" },
      ],
    },

    {
      title: "View",
      product: "EINVOICE",
      items: [
         { path: "/einvoice/single-invoice-details", label: "Single Invoice" },
         { path: "/einvoice/list-of-invoices", label: "Invoice List" },
      ],
    },

  ];

  const visibleSections = menuSections.filter(
    (s) => !s.product || s.product === product
  );

  /* --------------------------------
     UI
  --------------------------------- */
  return (
    <div
      style={{
        width: 270,
        background: "#1A73E8",
        color: "#fff",
        height: "100vh",
        padding: 20,
        overflowY: "auto",
      }}
    >
      <h3 style={{ textAlign: "center", marginBottom: 20 }}>
        IRISGST API Portal
        {product && (
          <div style={{ fontSize: 13, color: "#B3E5FC" }}>
            ({product})
          </div>
        )}
      </h3>

      {visibleSections.map((section) => (
        <div key={section.title} style={{ marginBottom: 6 }}>
          <div
            onClick={() => toggle(section.title)}
            style={{
              cursor: "pointer",
              padding: "10px 12px",
              fontWeight: "bold",
              borderRadius: 6,
              background: openSections[section.title]
                ? "#2c84f8"
                : "transparent",
              display: "flex",
              justifyContent: "space-between",
              alignItems: "center",
            }}
          >
            {section.title}
            <span>{openSections[section.title] ? "▾" : "▸"}</span>
          </div>

          {openSections[section.title] &&
            section.items.map((item) => (
              <Link
                key={item.path}
                to={item.path}
                style={{
                  display: "block",
                  padding: "8px 18px",
                  marginTop: 4,
                  borderRadius: 6,
                  fontSize: 14,
                  textDecoration: "none",
                  background: isActive(item.path) ? "#fff" : "transparent",
                  color: isActive(item.path) ? "#1A73E8" : "#fff",
                }}
              >
                {item.label}
              </Link>
            ))}
        </div>
      ))}
    </div>
  );
};

export default Sidebar;
